const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const EmbedUtils = require('../utils/embeds');
const logger = require('../utils/logger');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('help')
        .setDescription('üìñ Mostra a lista de comandos dispon√≠veis')
        .addStringOption(option =>
            option.setName('comando')
                .setDescription('Comando espec√≠fico para ver mais detalhes')
                .setRequired(false)),

    async execute(interaction) {
        try {
            logger.info(`[HELP] Comando executado por ${interaction.user.tag} (${interaction.user.id}) no servidor ${interaction.guild?.name || 'DM'} (${interaction.guild?.id || 'DM'})`);
            const commandName = interaction.options.getString('comando');

            if (commandName) {
                // Mostrar ajuda espec√≠fica do comando
                const commandHelp = getCommandHelp(commandName);
                if (commandHelp) {
                    const embed = new EmbedBuilder()
                        .setColor('#3498db')
                        .setTitle(`üìñ Ajuda: /${commandName}`)
                        .setDescription(commandHelp.description)
                        .addFields(
                            { name: 'üîß Uso', value: commandHelp.usage, inline: false },
                            { name: 'üìù Descri√ß√£o', value: commandHelp.description, inline: false },
                            { name: 'üîë Permiss√£o', value: commandHelp.permission || 'Nenhuma', inline: true },
                            { name: 'üí° Exemplo', value: commandHelp.example, inline: true }
                        )
                        .setThumbnail(interaction.client.user.displayAvatarURL({ dynamic: true }))
                        .setTimestamp()
                        .setFooter({ text: 'Lonex - Sistema de Ajuda', iconURL: interaction.client.user.displayAvatarURL({ dynamic: true }) });

                    await interaction.reply({ embeds: [embed] });
                } else {
                    const errorEmbed = new EmbedBuilder()
                        .setColor('#ff4757')
                        .setTitle('‚ùå Comando N√£o Encontrado')
                        .setDescription(`O comando **/${commandName}** n√£o foi encontrado.`)
                        .addFields(
                            { name: 'üí° Dica', value: 'Use `/help` para ver todos os comandos dispon√≠veis.', inline: false }
                        )
                        .setTimestamp();
                    
                    await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
                }
            } else {
                // Mostrar lista geral de comandos
                const embed = new EmbedBuilder()
                    .setColor('#3498db')
                    .setTitle('üìñ Central de Ajuda - Lonex')
                    .setDescription('Bem-vindo ao sistema de ajuda do **Lonex**! Escolha uma categoria abaixo para ver os comandos dispon√≠veis.')
                    .addFields([
                        { name: 'üõ°Ô∏è Modera√ß√£o', value: '`/ban`, `/kick`, `/mute`, `/clear`, `/warn`, `/unmute`', inline: true },
                        { name: 'üìä Informa√ß√µes', value: '`/userinfo`, `/serverinfo`, `/stats`, `/ping`, `/avatar`', inline: true },
                        { name: 'üéÆ Divers√£o', value: '`/sorteio`, `/enquete`, `/coinflip`, `/dice`, `/8ball`', inline: true },
                        { name: '‚öôÔ∏è Utilit√°rios', value: '`/remind`, `/lock`, `/unlock`, `/slowmode`, `/config`', inline: true },
                        { name: 'üîß Administra√ß√£o', value: '`/roleinfo`, `/servericon`, `/banner`, `/purge`', inline: true }
                    ])
                    .setThumbnail(interaction.client.user.displayAvatarURL({ dynamic: true }))
                    .setTimestamp()
                    .setFooter({ text: 'Lonex - Sistema de Ajuda', iconURL: interaction.client.user.displayAvatarURL({ dynamic: true }) });

                // Bot√µes para categorias
                const row1 = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId('help_moderation')
                            .setLabel('üõ°Ô∏è Modera√ß√£o')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('help_info')
                            .setLabel('üìä Informa√ß√µes')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('help_fun')
                            .setLabel('üéÆ Divers√£o')
                            .setStyle(ButtonStyle.Primary)
                    );

                const row2 = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId('help_utils')
                            .setLabel('‚öôÔ∏è Utilit√°rios')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('help_admin')
                            .setLabel('üîß Administra√ß√£o')
                            .setStyle(ButtonStyle.Primary)
                    );

                const response = await interaction.reply({
                    embeds: [embed],
                    components: [row1, row2],
                    fetchReply: true
                });

                // Coletor de bot√µes
                const collector = response.createMessageComponentCollector({ time: 300000 });

                collector.on('collect', async (i) => {
                    if (i.user.id !== interaction.user.id) {
                        return i.reply({ content: '‚ùå Apenas quem executou o comando pode usar estes bot√µes.', ephemeral: true });
                    }

                    const categoryEmbeds = {
                        'help_moderation': createModerationEmbed(),
                        'help_info': createInfoEmbed(),
                        'help_fun': createFunEmbed(),
                        'help_utils': createUtilsEmbed(),
                        'help_admin': createAdminEmbed()
                    };

                    const categoryEmbed = categoryEmbeds[i.customId];
                    if (categoryEmbed) {
                        await i.update({ embeds: [categoryEmbed] });
                    }
                });

                collector.on('end', async (collected) => {
                    if (collected.size === 0) {
                        const timeoutEmbed = new EmbedBuilder()
                            .setColor('#747d8c')
                            .setTitle('‚è∞ Tempo Expirado')
                            .setDescription('O tempo para navegar pela ajuda expirou.')
                            .setTimestamp();
                        
                        await interaction.editReply({ embeds: [timeoutEmbed], components: [] });
                    }
                });
            }

        } catch (error) {
            logger.error(`[HELP] Erro ao mostrar ajuda: ${error}`);
            const errorEmbed = new EmbedBuilder()
                .setColor('#ff4757')
                .setTitle('‚ùå Erro')
                .setDescription('Ocorreu um erro ao mostrar a ajuda.')
                .setTimestamp();
            
            await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
        }
    }
};

function getCommandHelp(commandName) {
    const helpTexts = {
        'ban': {
            usage: '`/ban <usuario> [motivo] [dias]`',
            description: 'Bane um usu√°rio permanentemente do servidor.',
            permission: 'Banir Membros',
            example: '`/ban @usuario Spam 7`'
        },
        'kick': {
            usage: '`/kick <usuario> [motivo]`',
            description: 'Expulsa um usu√°rio do servidor.',
            permission: 'Expulsar Membros',
            example: '`/kick @usuario Comportamento inadequado`'
        },
        'mute': {
            usage: '`/mute <usuario> [duracao] [motivo]`',
            description: 'Silencia um usu√°rio temporariamente.',
            permission: 'Moderar Membros',
            example: '`/mute @usuario 1h Spam`'
        },
        'clear': {
            usage: '`/clear <quantidade> [usuario]`',
            description: 'Deleta mensagens do canal.',
            permission: 'Gerenciar Mensagens',
            example: '`/clear 10 @usuario`'
        },
        'userinfo': {
            usage: '`/userinfo [usuario]`',
            description: 'Mostra informa√ß√µes detalhadas de um usu√°rio.',
            permission: 'Nenhuma',
            example: '`/userinfo @usuario`'
        },
        'serverinfo': {
            usage: '`/serverinfo`',
            description: 'Mostra informa√ß√µes detalhadas do servidor.',
            permission: 'Nenhuma',
            example: '`/serverinfo`'
        },
        'stats': {
            usage: '`/stats`',
            description: 'Mostra estat√≠sticas do servidor.',
            permission: 'Gerenciar Servidor',
            example: '`/stats`'
        },
        'ping': {
            usage: '`/ping`',
            description: 'Mostra a lat√™ncia do bot.',
            permission: 'Nenhuma',
            example: '`/ping`'
        },
        'avatar': {
            usage: '`/avatar [usuario]`',
            description: 'Mostra o avatar de um usu√°rio em tamanho grande.',
            permission: 'Nenhuma',
            example: '`/avatar @usuario`'
        }
    };

    return helpTexts[commandName] || null;
}

function createModerationEmbed() {
    return new EmbedBuilder()
        .setColor('#e74c3c')
        .setTitle('üõ°Ô∏è Comandos de Modera√ß√£o')
        .setDescription('Comandos para moderar o servidor e manter a ordem.')
        .addFields([
            { name: 'üî® /ban', value: 'Bane um usu√°rio permanentemente', inline: true },
            { name: 'üë¢ /kick', value: 'Expulsa um usu√°rio do servidor', inline: true },
            { name: 'üîá /mute', value: 'Silencia um usu√°rio temporariamente', inline: true },
            { name: 'üßπ /clear', value: 'Deleta mensagens do canal', inline: true },
            { name: '‚ö†Ô∏è /warn', value: 'Avisa um usu√°rio', inline: true },
            { name: 'üîä /unmute', value: 'Remove o silenciamento de um usu√°rio', inline: true }
        ])
        .setThumbnail('https://cdn.discordapp.com/emojis/1234567890.png')
        .setTimestamp()
        .setFooter({ text: 'Lonex - Sistema de Modera√ß√£o', iconURL: 'https://cdn.discordapp.com/emojis/1234567890.png' });
}

function createInfoEmbed() {
    return new EmbedBuilder()
        .setColor('#3498db')
        .setTitle('üìä Comandos de Informa√ß√µes')
        .setDescription('Comandos para obter informa√ß√µes sobre usu√°rios, servidor e bot.')
        .addFields([
            { name: 'üë§ /userinfo', value: 'Informa√ß√µes detalhadas de um usu√°rio', inline: true },
            { name: 'üè† /serverinfo', value: 'Informa√ß√µes detalhadas do servidor', inline: true },
            { name: 'üìà /stats', value: 'Estat√≠sticas do servidor', inline: true },
            { name: 'üèì /ping', value: 'Lat√™ncia do bot', inline: true },
            { name: 'üñºÔ∏è /avatar', value: 'Avatar de um usu√°rio em tamanho grande', inline: true }
        ])
        .setThumbnail('https://cdn.discordapp.com/emojis/1234567890.png')
        .setTimestamp()
        .setFooter({ text: 'Lonex - Sistema de Informa√ß√µes', iconURL: 'https://cdn.discordapp.com/emojis/1234567890.png' });
}

function createFunEmbed() {
    return new EmbedBuilder()
        .setColor('#f39c12')
        .setTitle('üéÆ Comandos de Divers√£o')
        .setDescription('Comandos divertidos para entreter os membros.')
        .addFields([
            { name: 'üéâ /sorteio', value: 'Cria um sorteio', inline: true },
            { name: 'üìä /enquete', value: 'Cria uma enquete', inline: true },
            { name: 'ü™ô /coinflip', value: 'Cara ou coroa', inline: true },
            { name: 'üé≤ /dice', value: 'Rola um dado', inline: true },
            { name: 'üîÆ /8ball', value: 'Bola 8 m√°gica', inline: true }
        ])
        .setThumbnail('https://cdn.discordapp.com/emojis/1234567890.png')
        .setTimestamp()
        .setFooter({ text: 'Lonex - Sistema de Divers√£o', iconURL: 'https://cdn.discordapp.com/emojis/1234567890.png' });
}

function createUtilsEmbed() {
    return new EmbedBuilder()
        .setColor('#9b59b6')
        .setTitle('‚öôÔ∏è Comandos Utilit√°rios')
        .setDescription('Comandos √∫teis para o dia a dia.')
        .addFields([
            { name: '‚è∞ /remind', value: 'Define um lembrete', inline: true },
            { name: 'üîí /lock', value: 'Trava um canal', inline: true },
            { name: 'üîì /unlock', value: 'Destrava um canal', inline: true },
            { name: 'üêå /slowmode', value: 'Define modo lento', inline: true },
            { name: '‚öôÔ∏è /config', value: 'Configura√ß√µes do servidor', inline: true }
        ])
        .setThumbnail('https://cdn.discordapp.com/emojis/1234567890.png')
        .setTimestamp()
        .setFooter({ text: 'Lonex - Sistema de Utilit√°rios', iconURL: 'https://cdn.discordapp.com/emojis/1234567890.png' });
}

function createAdminEmbed() {
    return new EmbedBuilder()
        .setColor('#2ecc71')
        .setTitle('üîß Comandos de Administra√ß√£o')
        .setDescription('Comandos avan√ßados para administradores.')
        .addFields([
            { name: 'üé≠ /roleinfo', value: 'Informa√ß√µes de um cargo', inline: true },
            { name: 'üñºÔ∏è /servericon', value: '√çcone do servidor', inline: true },
            { name: 'üè≥Ô∏è /banner', value: 'Banner do servidor', inline: true },
            { name: 'üóëÔ∏è /purge', value: 'Limpeza avan√ßada de mensagens', inline: true }
        ])
        .setThumbnail('https://cdn.discordapp.com/emojis/1234567890.png')
        .setTimestamp()
        .setFooter({ text: 'Lonex - Sistema de Administra√ß√£o', iconURL: 'https://cdn.discordapp.com/emojis/1234567890.png' });
} 